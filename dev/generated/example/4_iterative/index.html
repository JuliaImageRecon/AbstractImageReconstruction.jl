<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Iterative Reconstruction · AbstractImageReconstruction.jl</title><meta name="title" content="Iterative Reconstruction · AbstractImageReconstruction.jl"/><meta property="og:title" content="Iterative Reconstruction · AbstractImageReconstruction.jl"/><meta property="twitter:title" content="Iterative Reconstruction · AbstractImageReconstruction.jl"/><meta name="description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="twitter:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/example/4_iterative/"/><meta property="twitter:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/example/4_iterative/"/><link rel="canonical" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/example/4_iterative/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">AbstractImageReconstruction.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Example: Radon Reconstruction Package</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../example_intro/">Introduction</a></li><li><a class="tocitem" href="../0_radon_data/">Radon Data</a></li><li><a class="tocitem" href="../1_interface/">Interface</a></li><li><a class="tocitem" href="../2_direct/">Direct Reconstruction</a></li><li><a class="tocitem" href="../3_direct_result/">Direct Reconstruction Result</a></li><li class="is-active"><a class="tocitem" href>Iterative Reconstruction</a><ul class="internal"><li><a class="tocitem" href="#Parameters-and-Processing"><span>Parameters and Processing</span></a></li><li><a class="tocitem" href="#Algorithm"><span>Algorithm</span></a></li></ul></li><li><a class="tocitem" href="../5_iterative_result/">Iterative Reconstruction Result</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../howto/serialization/">Serialization</a></li><li><a class="tocitem" href="../../howto/caching/">Caching</a></li><li><a class="tocitem" href="../../howto/observables/">Observables</a></li></ul></li><li><a class="tocitem" href="../../../API/api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Example: Radon Reconstruction Package</a></li><li class="is-active"><a href>Iterative Reconstruction</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Iterative Reconstruction</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/blob/main/docs/src/literate/example/4_iterative.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Iterative-Reconstruction"><a class="docs-heading-anchor" href="#Iterative-Reconstruction">Iterative Reconstruction</a><a id="Iterative-Reconstruction-1"></a><a class="docs-heading-anchor-permalink" href="#Iterative-Reconstruction" title="Permalink"></a></h1><p>In this section we implement a more complex iterative reconstruction algorithm. We will use iterative solvers provided by <a href="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl">RegularizedLeastSquares.jl</a>. These solver feature a variety of arguments, in this example we will just focus on the parameters for the number of iterations and regularization. Each solver requires either a matrix or a matrix-free linear operator which implements multiplication with a vector as input. We will use <a href="https://github.com/JuliaImageRecon/LinearOperatorCollection.jl">LinearOperatorCollection.jl</a>, which implements a wrapper around RadonKA.</p><p>For this example, we will further assume that the construction of this operator is costly and should be done only once. This means our algorithm will be stateful and has to store the operator.</p><h2 id="Parameters-and-Processing"><a class="docs-heading-anchor" href="#Parameters-and-Processing">Parameters and Processing</a><a id="Parameters-and-Processing-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters-and-Processing" title="Permalink"></a></h2><p>We will start by defining the parameters for the algorithm and the processing steps. Afterwards we can implement the algorithm itself. Since we will use the same preprocessing as for the direct reconstruction, we can reuse the parameters and processing steps and jump directly to the iterative parameters:</p><pre><code class="language-julia hljs">using RegularizedLeastSquares, LinearOperatorCollection
abstract type AbstractIterativeRadonReconstructionParameters &lt;: AbstractRadonReconstructionParameters end
Base.@kwdef struct IterativeRadonReconstructionParameters{S &lt;: AbstractLinearSolver, R &lt;: AbstractRegularization, N} &lt;: AbstractIterativeRadonReconstructionParameters
  solver::Type{S}
  iterations::Int64
  reg::Vector{R}
  shape::NTuple{N, Int64}
  angles::Vector{Float64}
end</code></pre><p>The parameters of this struct can be grouped into three catergories. The solver type just specifies which solver to use. The number of iterations and the regularization term could be abstracted into a nested <code>AbstractRadonParameter</code> which describe the parameters for the solver. Lastly the shape and angles are required to construct the linear operator.</p><p>Since we want to construct the linear operator only once, we will write the <code>process</code> method with the operator as a given argument:</p><pre><code class="language-julia hljs">function AbstractImageReconstruction.process(::Type{&lt;:AbstractIterativeRadonAlgorithm}, params::IterativeRadonReconstructionParameters, op, data::AbstractArray{T, 4}) where {T}
  solver = createLinearSolver(params.solver, op; iterations = params.iterations, reg = params.reg)

  result = similar(data, params.shape..., size(data, 4))

  for i = 1:size(data, 4)
    result[:, :, :, i] = solve!(solver, vec(data[:, :, :, i]))
  end

  return result
end</code></pre><p>Later we need to define to create the operator and pass it to this <code>process</code> method.</p><h2 id="Algorithm"><a class="docs-heading-anchor" href="#Algorithm">Algorithm</a><a id="Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Algorithm" title="Permalink"></a></h2><p>Similar to the direct reconstruction algorithm, we want our iterative algorithm to accept both preprocessing and reconstruction parameters. We will encode this in a new type:</p><pre><code class="language-julia hljs">Base.@kwdef struct IterativeRadonParameters{P&lt;:AbstractRadonPreprocessingParameters, R&lt;:AbstractIterativeRadonReconstructionParameters} &lt;: AbstractRadonParameters
  pre::P
  reco::R
end</code></pre><p>Instead of defining essentially the same struct again, we could also define a more generic one and specify the supported reconstruction parameter as type constraints in the algorithm constructor.</p><p>Unlike the direct reconstruction algorithm, the iterative algorithm has to store the linear operator. We will store it as a field in the algorithm type:</p><pre><code class="language-julia hljs">mutable struct IterativeRadonAlgorithm{D &lt;: IterativeRadonParameters} &lt;: AbstractIterativeRadonAlgorithm
  parameter::D
  op::Union{Nothing, AbstractLinearOperator}
  output::Channel{Any}
end</code></pre><p>We will set the operator to <code>nothing</code> in the constructor:</p><pre><code class="language-julia hljs">function IterativeRadonAlgorithm(parameter::D) where D
  return IterativeRadonAlgorithm{D}(parameter, nothing, Channel{Any}(Inf))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.IterativeRadonAlgorithm</code></pre><p>Next we implement the <code>process</code> method for our reconstruction parameters and an algorithm instance. This allows us to access the operator and pass it to the processing step:</p><pre><code class="language-julia hljs">function AbstractImageReconstruction.process(algo::IterativeRadonAlgorithm, params::IterativeRadonParameters{P, R}, data::AbstractArray{T, 4}) where {T, P&lt;:AbstractRadonPreprocessingParameters, R&lt;:AbstractIterativeRadonReconstructionParameters}
  data = process(algo, params.pre, data)
  return process(algo, params.reco, algo.op, data)
end</code></pre><p>Note that initially the operator is <code>nothing</code> and the processing step would fail as it stands. To &quot;fix&quot; this we define a <code>process</code> method for the algorithm instance which creates the operator and stores it in the algorithm:</p><pre><code class="language-julia hljs">function AbstractImageReconstruction.process(algo::IterativeRadonAlgorithm, params::IterativeRadonReconstructionParameters, ::Nothing, data::AbstractArray{T, 4}) where {T}
  op = RadonOp(T; shape = params.shape, angles = params.angles)
  algo.op = op
  return process(AbstractIterativeRadonAlgorithm, params, op, data)
end</code></pre><p>Our algorithm is not type stable. To fix this, we would need to know the element type of the sinograms during construction. Which is possible with a different parameterization of the algorithm. We will not do this here. Often times the performance impact of this is negligible as the critical sections are in the preprocessing or the iterative solver, especially since we still dispatch on the operator.</p><p>To finish up the implementation we need to implement the <code>put!</code>, <code>take!</code> and <code>parameters</code> functions:</p><pre><code class="language-julia hljs">Base.take!(algo::IterativeRadonAlgorithm) = Base.take!(algo.output)
function Base.put!(algo::IterativeRadonAlgorithm, data::AbstractArray{T, 4}) where {T}
  lock(algo.output) do
    put!(algo.output, process(algo, algo.parameter, data))
  end
end
AbstractImageReconstruction.parameter(algo::IterativeRadonAlgorithm) = algo.parameter</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../3_direct_result/">« Direct Reconstruction Result</a><a class="docs-footer-nextpage" href="../5_iterative_result/">Iterative Reconstruction Result »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 11 December 2024 17:05">Wednesday 11 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
