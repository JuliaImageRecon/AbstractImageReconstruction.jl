<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-Threading · AbstractImageReconstruction.jl</title><meta name="title" content="Multi-Threading · AbstractImageReconstruction.jl"/><meta property="og:title" content="Multi-Threading · AbstractImageReconstruction.jl"/><meta property="twitter:title" content="Multi-Threading · AbstractImageReconstruction.jl"/><meta name="description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="twitter:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/multi_threading/"/><meta property="twitter:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/multi_threading/"/><link rel="canonical" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/multi_threading/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">AbstractImageReconstruction.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Example: Radon Reconstruction Package</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../example_intro/">Introduction</a></li><li><a class="tocitem" href="../../example/0_radon_data/">Radon Data</a></li><li><a class="tocitem" href="../../example/1_interface/">Interface</a></li><li><a class="tocitem" href="../../example/2_direct/">Direct Reconstruction</a></li><li><a class="tocitem" href="../../example/3_direct_result/">Direct Reconstruction Result</a></li><li><a class="tocitem" href="../../example/4_iterative/">Iterative Reconstruction</a></li><li><a class="tocitem" href="../../example/5_iterative_result/">Iterative Reconstruction Result</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../serialization/">Serialization</a></li><li><a class="tocitem" href="../caching/">Caching</a></li><li><a class="tocitem" href="../observables/">Observables</a></li><li class="is-active"><a class="tocitem" href>Multi-Threading</a></li></ul></li><li><a class="tocitem" href="../../../API/api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to</a></li><li class="is-active"><a href>Multi-Threading</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-Threading</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/blob/main/docs/src/literate/howto/multi_threading.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-Threading"><a class="docs-heading-anchor" href="#Multi-Threading">Multi-Threading</a><a id="Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Threading" title="Permalink"></a></h1><p><code>AbstractImageReconstruction</code> assumes that algorithms are stateful. This is reflected in the FIFO behaviour and the locking interface of algorithms. The motivation behind this choice is that the nature of computations within an algorithms heavily impact if multi-threading is beneficial or not. For example, consider a GPU-accelerated reconstruction. There it might be faster to sequentially process all images on the GPU instead of processing them in parallel. Or consider, the preprocessing step of the Radon example where we average our data. If we were to extend our algorithm to read sinograms from a file, it might be inefficient to partially read and average frames from the file in parallel. Instead it would be more efficient to read the required file in one go and then average the frames in parallel. Therefore, the actual runtime behaviour is intended to be an implementation detail of an algorithm which is to be abstracted behind <code>reconstruct</code>.</p><p>In the following we will explore the results of this design decision. If we consider a n algorithm such as:</p><pre><code class="language-julia hljs">plan = RecoPlan(IterativeRadonAlgorithm, parameter = RecoPlan(IterativeRadonParameters,
  pre = RecoPlan(RadonPreprocessingParameters, frames = collect(1:5)),
  reco = RecoPlan(IterativeRadonReconstructionParameters, shape = size(images)[1:3], angles = angles,
            iterations = 20, reg = [L2Regularization(0.001), PositiveRegularization()], solver = CGNR)
))
algo = build(plan)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.OurRadonReco.IterativeRadonAlgorithm{Main.OurRadonReco.IterativeRadonParameters{Main.OurRadonReco.RadonPreprocessingParameters, Main.OurRadonReco.IterativeRadonReconstructionParameters{RegularizedLeastSquares.CGNR, RegularizedLeastSquares.AbstractRegularization, 3}}}(Main.OurRadonReco.IterativeRadonParameters{Main.OurRadonReco.RadonPreprocessingParameters, Main.OurRadonReco.IterativeRadonReconstructionParameters{RegularizedLeastSquares.CGNR, RegularizedLeastSquares.AbstractRegularization, 3}}(Main.OurRadonReco.RadonPreprocessingParameters([1, 2, 3, 4, 5], 1), Main.OurRadonReco.IterativeRadonReconstructionParameters{RegularizedLeastSquares.CGNR, RegularizedLeastSquares.AbstractRegularization, 3}(RegularizedLeastSquares.CGNR, 20, RegularizedLeastSquares.AbstractRegularization[RegularizedLeastSquares.L2Regularization{Float64}(0.001), RegularizedLeastSquares.PositiveRegularization()], (64, 64, 64), [0.0, 0.012319971190548208, 0.024639942381096416, 0.036959913571644624, 0.04927988476219283, 0.06159985595274104, 0.07391982714328925, 0.08623979833383746, 0.09855976952438567, 0.11087974071493388  …  3.030712912874859, 3.0430328840654073, 3.0553528552559555, 3.067672826446504, 3.0799927976370522, 3.0923127688276004, 3.1046327400181486, 3.1169527112086968, 3.129272682399245, 3.141592653589793])), nothing, Channel{Any}(9223372036854775807))</code></pre><p>which acts on one frame at a time, we could in theory do:</p><pre><code class="language-julia hljs">Threads.@threads for i = 1:size(sinograms, 4)
 res = reconstruct(algo, sinograms[:, :, :, i:i])
 # Store res
end</code></pre><p>Due to the locking interface of the algorithm, this will not actually run in parallel. Instead the algorithm will be locked for each iteration and tasks will wait for the previous reconstruction to finish.</p><p>If a user wants to explicitly use multi-threading, we could the plan to create a new algorithm for each task:</p><pre><code class="language-julia hljs">Threads.@threads for i = 1:size(sinograms, 4)
  algo = build(plan)
  res = reconstruct(algo, sinograms[:, :, :, i:i])
  # Store res
end</code></pre><p>This way each task has its own algorithm and can run in parallel. As mentioned before, this parallelization might not be the most efficient parallel reconstruction, both in terms of memory and runtime.</p><p>To further improve the performance of the reconstruction, we could implement specific multi-threading <code>process</code>-ing steps for our algorithms. As an example, we will implement parallel processing for the iterative solver:</p><pre><code class="language-julia hljs">Base.@kwdef struct ThreadedIterativeReconstructionParameters{S &lt;: AbstractLinearSolver, R &lt;: AbstractRegularization, N} &lt;: AbstractIterativeRadonReconstructionParameters
  solver::Type{S}
  iterations::Int64
  reg::Vector{R}
  shape::NTuple{N, Int64}
  angles::Vector{Float64}
end</code></pre><p>Our parameters are identical to the iterative reconstruction parameters from the iterative example. We only differ in the type of the parameters. This allows us to dispatch on the type of the parameters and implement a different <code>process</code> method for the threaded version:</p><pre><code class="language-julia hljs">function AbstractImageReconstruction.process(::Type{&lt;:AbstractIterativeRadonAlgorithm}, params::ThreadedIterativeReconstructionParameters, op, data::AbstractArray{T, 4}) where {T}

  result = similar(data, params.shape..., size(data, 4))

  Threads.@threads for i = 1:size(data, 4)
    solver = createLinearSolver(params.solver, op; iterations = params.iterations, reg = params.reg)
    result[:, :, :, i] = solve!(solver, vec(data[:, :, :, i]))
  end

  return result
end</code></pre><p>While the Radon operator is thread-safe, the normal operator constructed by the solver is not. Therefore, we can reuse the Radon operator but still have to construct new solvers for each task.</p><p>Our multi-threaded reconstruction can be constructed and used just like the single-threaded one::</p><pre><code class="language-julia hljs">plan.parameter.pre.frames = collect(1:size(sinograms, 4))
plan.parameter.reco = RecoPlan(ThreadedIterativeReconstructionParameters, shape = size(images)[1:3], angles = angles,
            iterations = 20, reg = [L2Regularization(0.001), PositiveRegularization()], solver = CGNR)

algo = build(plan)
imag_iter = reconstruct(algo, sinograms)
fig = Figure()
for i = 1:5
  plot_image(fig[i,1], reverse(images[:, :, 24, i]))
  plot_image(fig[i,2], sinograms[:, :, 24, i])
  plot_image(fig[i,3], reverse(imag_iter[:, :, 24, i]))
end
resize_to_layout!(fig)
fig</code></pre><img src="2d8fa6d3.png" alt="Example block output"/><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../observables/">« Observables</a><a class="docs-footer-nextpage" href="../../../API/api/">API Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 28 January 2025 10:37">Tuesday 28 January 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
