<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Caching · AbstractImageReconstruction.jl</title><meta name="title" content="Caching · AbstractImageReconstruction.jl"/><meta property="og:title" content="Caching · AbstractImageReconstruction.jl"/><meta property="twitter:title" content="Caching · AbstractImageReconstruction.jl"/><meta name="description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="twitter:description" content="Documentation for AbstractImageReconstruction.jl."/><meta property="og:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/caching/"/><meta property="twitter:url" content="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/caching/"/><link rel="canonical" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/generated/howto/caching/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">AbstractImageReconstruction.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Example: Radon Reconstruction Package</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../example_intro/">Introduction</a></li><li><a class="tocitem" href="../../example/0_radon_data/">Radon Data</a></li><li><a class="tocitem" href="../../example/1_interface/">Interface</a></li><li><a class="tocitem" href="../../example/2_direct/">Direct Reconstruction</a></li><li><a class="tocitem" href="../../example/3_direct_result/">Direct Reconstruction Result</a></li><li><a class="tocitem" href="../../example/4_iterative/">Iterative Reconstruction</a></li><li><a class="tocitem" href="../../example/5_iterative_result/">Iterative Reconstruction Result</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../serialization/">Serialization</a></li><li class="is-active"><a class="tocitem" href>Caching</a><ul class="internal"><li><a class="tocitem" href="#ProcessResultCache"><span>ProcessResultCache</span></a></li></ul></li><li><a class="tocitem" href="../observables/">Observables</a></li><li><a class="tocitem" href="../multi_threading/">Multi-Threading</a></li></ul></li><li><a class="tocitem" href="../../../API/api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to</a></li><li class="is-active"><a href>Caching</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Caching</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaImageRecon/AbstractImageReconstruction.jl/blob/main/docs/src/literate/howto/caching.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Caching"><a class="docs-heading-anchor" href="#Caching">Caching</a><a id="Caching-1"></a><a class="docs-heading-anchor-permalink" href="#Caching" title="Permalink"></a></h1><p>Image reconstruction algorithms can be computationally expensive. To avoid unnecessary recomputations, we can cache the results of processing steps. This can be especially helpful if a user wants to change parameters of an algorithm that only impact parts of the processing. We have seen a small example of caching in the <code>IterativeRadonAlgorithm</code> implementation. There the algorithm itself cached a result in its properties. <code>AbstractImageReconstruction</code> provides a more general caching mechanism that can be used for any processing step. However, the caching mechanism is not enabled by default and has to be explicitly implemented by the algorithm developer.</p><p>This How-To builds on the results of the example sections.</p><h2 id="ProcessResultCache"><a class="docs-heading-anchor" href="#ProcessResultCache">ProcessResultCache</a><a id="ProcessResultCache-1"></a><a class="docs-heading-anchor-permalink" href="#ProcessResultCache" title="Permalink"></a></h2><p>The caching mechanism is based on the <code>ProcessResultCache</code> type. This type wraps around a different <code>AbstractImageReconstructionParameter</code> and caches the result of a processing step. Such a <code>process</code>ing step which offer functionality to other <code>process</code> steps is a <code>AbstractUtilityReconstructionParameter</code>. These utility steps should return the same result as if the inner step was called directly.</p><p>The cache itself is connected to a <code>RecoPlan</code> and any instances build from the same plan instance share this cache and can reuse the result of the processing step.</p><p>Let&#39;s implement the <code>ProcessResultCache</code> type for the Radon preprocessing step. We first define a struct a very costly preprocessing step:</p><pre><code class="language-julia hljs">Base.@kwdef struct CostlyPreprocessingParameters &lt;: AbstractRadonPreprocessingParameters
  frames::Vector{Int64} = []
  runtime::Float64 = 1.0
end
function AbstractImageReconstruction.process(::Type{&lt;:AbstractRadonAlgorithm}, params::CostlyPreprocessingParameters, data::AbstractArray{T, 4}) where {T}
  frames = isempty(params.frames) ? (1:size(data, 4)) : params.frames
  data = data[:, :, :, frames]
  @info &quot;Very costly preprocessing step&quot;
  sleep(params.runtime)
  return data
end</code></pre><p>Now we can define a processing step that internally uses another processing step. We allow this inner parameter to be cached by considering the following <code>Union</code>:</p><pre><code class="language-julia hljs">Base.@kwdef struct RadonCachedPreprocessingParameters{P &lt;: AbstractRadonPreprocessingParameters, PU &lt;: AbstractUtilityReconstructionParameters{P}} &lt;: AbstractRadonPreprocessingParameters
  params::Union{P, PU}
end</code></pre><p>Note that this case is a bit artifical and a more sensible place would be the algorithm parameters themselves. However, for the case of simplicity we did not introduce the concept in the example. In this artifical case we just pass the parameters to the processing step. A real implementation might do some more processing with the result of the inner processing step:</p><pre><code class="language-julia hljs">AbstractImageReconstruction.process(algoT::Type{&lt;:AbstractRadonAlgorithm}, params::RadonCachedPreprocessingParameters, args...) = process(algoT, params.params, args...)</code></pre><p>We deliberaly implement the <code>process</code> function for algorithm type to avoid our cache being invalided by state changes of an algoritm instance.</p><p>Now we construct a plan for a direct reconstruction algorithm that uses the costly preprocessing step:</p><pre><code class="language-julia hljs">pre = CostlyPreprocessingParameters(; frames = collect(1:3), runtime = 1.0)
preCached = RadonCachedPreprocessingParameters(ProcessResultCache(pre, maxsize = 2))
prePlan = toPlan(preCached)
recoPlan = RecoPlan(IterativeRadonReconstructionParameters; angles = angles, shape = size(images)[1:3],
            iterations = 10, reg = [L2Regularization(0.001), PositiveRegularization()], solver = CGNR)
params = RecoPlan(IterativeRadonParameters; pre = prePlan, reco = recoPlan)
plan = RecoPlan(IterativeRadonAlgorithm; parameter = params)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RecoPlan{Main.OurRadonReco.IterativeRadonAlgorithm}
└─ parameter::RecoPlan{Main.OurRadonReco.IterativeRadonParameters}
   ├─ reco::RecoPlan{Main.OurRadonReco.IterativeRadonReconstructionParameters}
   │  ├─ iterations = 10
   │  ├─ solver = CGNR
   │  ├─ reg = AbstractRegularization[L2Regularization{Float64}(0.001), PositiveRegularization()]
   │  ├─ angles = [0.0, 0.01232, 0.0246399, 0.0369599, 0.0492799, 0.0615999, 0.0739198, 0.0862398, 0.0985598, 0.11088  …  3.03071, 3.04303, 3.05535, 3.06767, 3.07999, 3.09231, 3.10463, 3.11695, 3.12927, 3.14159]
   │  └─ shape = (64, 64, 64)
   └─ pre::RecoPlan{Main.RadonCachedPreprocessingParameters}
      └─ params::RecoPlan{Main.CostlyPreprocessingParameters} [Cached, 2]
         ├─ runtime = 1.0
         └─ frames = [1, 2, 3]
</code></pre><p>When we built the algorithm from the plan, the costly preprocessing step is only executed once and the result is cached and can be reused:</p><pre><code class="language-julia hljs">algo = build(plan)
reconstruct(algo, sinograms);
reconstruct(algo, sinograms);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Very costly preprocessing step</code></pre><p>If we change the parameters of the algorithms without affecting the preprocessing step, we can still reuse the cached result:</p><pre><code class="language-julia hljs">setAll!(plan, :iterations, 5)
algo = build(plan)
reconstruct(algo, sinograms);
plan.parameter.reco.iterations == 5</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><p><code>ProcessResultCache</code> uses a least recently used (LRU) strategy to store the results. The cache size can be set by the user and defaults to 1. If the cache is full, the least recently used result is removed from the cache.</p><p>The cache is checked with a key formed with the hash of all arguments of the processing step. <code>AbstractImageReconstruction</code> provides a default <code>hash</code> method for AbstractImageReconstructionParameters`, which hashes all properties of a parameter.</p><p>Other methods of cache invalidation are creating a new plan or manual invalidation of the cache:</p><pre><code class="language-julia hljs">empty!(algo.parameter.pre.params)
reconstruct(algo, sinograms);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Very costly preprocessing step</code></pre><p>Caches support serialization like other <code>RecoPlans</code>:</p><pre><code class="language-julia hljs">clear!(plan)
toTOML(stdout, plan)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">_module = &quot;Main.OurRadonReco&quot;
_type = &quot;RecoPlan{Main.OurRadonReco.IterativeRadonAlgorithm}&quot;

[parameter]
_module = &quot;Main.OurRadonReco&quot;
_type = &quot;RecoPlan{Main.OurRadonReco.IterativeRadonParameters}&quot;

    [parameter.reco]
    _module = &quot;Main.OurRadonReco&quot;
    _type = &quot;RecoPlan{Main.OurRadonReco.IterativeRadonReconstructionParameters}&quot;

    [parameter.pre]
    _module = &quot;Main&quot;
    _type = &quot;RecoPlan{Main.RadonCachedPreprocessingParameters}&quot;

        [parameter.pre.params]
        _module = &quot;AbstractImageReconstruction&quot;
        _type = &quot;RecoPlan{ProcessResultCache}&quot;

            [parameter.pre.params.param]
            _module = &quot;Main&quot;
            _type = &quot;RecoPlan{Main.CostlyPreprocessingParameters}&quot;</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../serialization/">« Serialization</a><a class="docs-footer-nextpage" href="../observables/">Observables »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.1 on <span class="colophon-date" title="Tuesday 1 April 2025 15:37">Tuesday 1 April 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
